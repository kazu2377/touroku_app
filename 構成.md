

## 機能要件（最小）

1. Supabase Auth でログイン（メール）
2. ログイン後の画面で「目標」を投稿できる
3. 投稿された目標は全ユーザーに公開（一覧表示）
4. 投稿者名（メール）と目標、作成日時を表示
5. App Router 構成

---

## ディレクトリ構成

```
app/
  layout.tsx
  page.tsx               ← 未ログインはここ（ログインボタン）
  dashboard/
    page.tsx             ← ログイン後の画面（目標投稿と一覧表示）
  api/goal/route.ts      ← 投稿API（POST）
lib/
  supabaseClient.ts
types/
  goal.ts
```

---

## Supabase 側で事前に作成するテーブル(すでに作成済み)

```sql
create table goals (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references auth.users(id),
  content text not null,
  created_at timestamp with time zone default now()
);
```

RLS（公開読み取り・ログインユーザーのみ書き込み）(すでに作成済み)

```sql
alter table goals enable row level security;

create policy "public_read" on goals
for select using (true);

create policy "insert_own" on goals
for insert with check (auth.uid() = user_id);
```

---

## lib/supabaseClient.ts

```ts
import { createBrowserClient, createServerClient } from "@supabase/ssr";

export const createClient = () =>
  createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );

export const createServer = (cookies: any) =>
  createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    { cookies }
  );
```

---

## app/layout.tsx

```tsx
export default function RootLayout({ children }) {
  return (
    <html lang="ja">
      <body>{children}</body>
    </html>
  );
}
```

---

## app/page.tsx（ログイン）

```tsx
"use client";

import { createClient } from "@/lib/supabaseClient";

export default function Page() {
  const supabase = createClient();

  const signIn = async () => {
    await supabase.auth.signInWithOAuth({ provider: "google" });
  };

  return (
    <main style={{ padding: 40 }}>
      <h1>ログインしてください</h1>
      <button onClick={signIn}>Google でログイン</button>
    </main>
  );
}
```

---

## app/dashboard/page.tsx（目標投稿 + 一覧表示）

```tsx
"use client";

import { useEffect, useState } from "react";
import { createClient } from "@/lib/supabaseClient";

type Goal = {
  id: string;
  content: string;
  created_at: string;
  user_id: string;
  email: string | null;
};

export default function DashboardPage() {
  const supabase = createClient();
  const [goals, setGoals] = useState<Goal[]>([]);
  const [input, setInput] = useState("");

  const fetchGoals = async () => {
    const { data } = await supabase
      .from("goals")
      .select("id, content, created_at, user_id, auth.users(email)")
      .order("created_at", { ascending: false });
    setGoals(
      data?.map((g) => ({
        id: g.id,
        content: g.content,
        created_at: g.created_at,
        user_id: g.user_id,
        email: g.users?.email ?? null,
      })) ?? []
    );
  };

  const addGoal = async () => {
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) return;

    await supabase.from("goals").insert({ content: input, user_id: user.id });
    setInput("");
    fetchGoals();
  };

  useEffect(() => {
    fetchGoals();
  }, []);

  return (
    <main style={{ padding: 40 }}>
      <h2>みんなの目標</h2>

      <div>
        <input
          value={input}
          onChange={(e) => setInput(e.target.value)}
          placeholder="今日の目標"
        />
        <button onClick={addGoal}>投稿</button>
      </div>

      <ul style={{ marginTop: 30 }}>
        {goals.map((g) => (
          <li key={g.id} style={{ marginBottom: 14 }}>
            <strong>{g.email}</strong>  
            <div>{g.content}</div>
            <small>{new Date(g.created_at).toLocaleString()}</small>
          </li>
        ))}
      </ul>
    </main>
  );
}
```

---

## ミドルウェア（未ログインは `/dashboard` を見れないように）

`middleware.ts`

```ts
import { NextResponse } from "next/server";
import { createServer } from "@/lib/supabaseClient";

export async function middleware(req) {
  const supabase = createServer({
    get: (name) => req.cookies.get(name)?.value,
    set: () => {}
  });

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user && req.nextUrl.pathname.startsWith("/dashboard")) {
    return NextResponse.redirect(new URL("/", req.url));
  }

  return NextResponse.next();
}
```

---

## .env.local（最低限）

```
NEXT_PUBLIC_SUPABASE_URL=xxxxx
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxxxx
```

---

## 動作フロー

1. `/` → ログインボタン
2. Supabase Auth 認証
3. `/dashboard` へ遷移
4. 目標を投稿 → `goals` に保存
5. 新着順で全ユーザーの目標を表示

---

## 補足

* Realtime を使えば投稿の自動反映も可能
* UI ライブラリ（shadcn/ui など）は任意
* MCP レベルの最小実装としては十分

---

必要であれば次の追加実装も可能
・削除 / 編集機能
・自分の目標のみフィルタ表示
・Like / コメント機能
・Realtime 購読
・Dockerfile と CI/CD

次にどこを広げたいですか？
UI、Realtime、API改善、DB追加、Docker化などどれでも対応できます。
